import{useState as e,useCallback as t,useEffect as n,useRef as a,createElement as r,memo as i,useMemo as l,Children as s}from"react";import"big.js";import{or as u,attribute as o,literal as c,contains as d,startsWith as h,endsWith as p,greaterThan as v,greaterThanOrEqual as f,equals as g,notEqual as m,lessThan as b,lessThanOrEqual as y}from"mendix/filters/builders";var w,C={exports:{}};
/*!
	Copyright (c) 2018 Jed Watson.
	Licensed under the MIT License (MIT), see
	http://jedwatson.github.io/classnames
*/w=C,function(){var e={}.hasOwnProperty;function t(){for(var n=[],a=0;a<arguments.length;a++){var r=arguments[a];if(r){var i=typeof r;if("string"===i||"number"===i)n.push(r);else if(Array.isArray(r)){if(r.length){var l=t.apply(null,r);l&&n.push(l)}}else if("object"===i){if(r.toString!==Object.prototype.toString&&!r.toString.toString().includes("[native code]")){n.push(r.toString());continue}for(var s in r)e.call(r,s)&&r[s]&&n.push(s)}}}return n.join(" ")}w.exports?(t.default=t,w.exports=t):window.classNames=t}();var N=C.exports;function S(a,r){const[i,l]=e(),s=t((()=>{l((e=>{const t=null==a?void 0:a.getBoundingClientRect();return r=t,(n=e)&&r&&n.height===r.height&&n.width===r.width&&n.bottom===r.bottom&&n.top===r.top&&n.left===r.left&&n.right===r.right?e:t;var n,r}))}),[a]);var u;return n((()=>u?function(e){let t;const n=()=>{t=window.requestAnimationFrame((()=>{e(),n()}))},a=()=>window.cancelAnimationFrame(t);return n(),a}(u):void 0),[u=r?s:void 0]),i}function F(i){const l=i.defaultFilter,s=i.onChange,[u,o]=e(l),[c,d]=e(!1),h=a(null),p=a(null);var v,f;n((()=>{const e=e=>{if(Array.isArray(v)){if(v.some((t=>!t.current||t.current.contains(e.target))))return}else if(!v.current||v.current.contains(e.target))return;f()};return document.addEventListener("mousedown",e),document.addEventListener("touchstart",e),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("touchstart",e)}}),[v=[h,p],f=()=>d(!1)]);const g=S(h.current,c),m=t((e=>{o(e),s(e,!0),d(!1)}),[s]);n((()=>{o(l),s(l,!1)}),[l,s]);const b=r("ul",{ref:p,id:"".concat(i.id,"-filter-selectors"),className:"filter-selectors",role:"menu","data-focusindex":0,style:{position:"fixed",top:null==g?void 0:g.bottom,left:null==g?void 0:g.left}},i.options.map(((e,t)=>r("li",{className:N({"filter-selected":u===e.value}),key:t,onClick:t=>{t.preventDefault(),t.stopPropagation(),m(e.value)},onKeyDown:n=>{if("Enter"===n.key||" "===n.key)n.preventDefault(),n.stopPropagation(),m(e.value);else if("Tab"===n.key&&t+1===i.options.length)n.preventDefault(),m(u);else if("Tab"===n.key&&n.shiftKey&&0===t||"Escape"===n.key){var a;n.preventDefault(),null===(a=h.current)||void 0===a||null===(a=a.querySelector("button"))||void 0===a||a.focus(),d(!1)}},role:"menuitem",tabIndex:0},r("div",{className:N("filter-icon",e.value),"aria-hidden":!0}),r("div",{className:"filter-label"},e.label))))),y=t((()=>{d((e=>!e)),setTimeout((()=>{var e;null===(e=p.current)||void 0===e||null===(e=e.querySelector("li.filter-selected"))||void 0===e||e.focus()}),10)}),[]);return r("div",{className:"filter-selector"},r("div",{className:"filter-selector-content",ref:h},r("button",{"aria-controls":"".concat(i.id,"-filter-selectors"),"aria-expanded":c,"aria-haspopup":!0,"aria-label":i.ariaLabel,className:N("btn btn-default filter-selector-button button-icon",u),onClick:y,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),e.stopPropagation(),y())}},"Â "),c&&b))}const E=i((function(e){var t;const{defaultFilter:n}=e;return r("div",{className:N("filter-container",e.className),"data-focusindex":null!==(t=e.tabIndex)&&void 0!==t?t:0,style:e.styles},e.adjustable&&r(F,{ariaLabel:e.screenReaderButtonCaption,id:e.id,defaultFilter:n,onChange:e.onFilterChange,options:e.filters}),r("input",{"aria-label":e.screenReaderInputCaption,className:N("form-control",{"filter-input":e.adjustable}),disabled:e.inputDisabled,onChange:e.onInputChange,placeholder:e.placeholder,ref:e.inputRef,type:e.inputType,value:e.inputValue}))})),V=Object.freeze({reset:{value:"reset.value",filters:"reset.filters"},set:{value:"set.value"}});function D(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var a=n.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}let T=()=>({emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];for(let t=0,a=this.events[e]||[],r=a.length;t<r;t++)a[t](...n)},events:{},on(e,t){var n;return((n=this.events)[e]||(n[e]=[])).push(t),()=>{var n;this.events[e]=null===(n=this.events[e])||void 0===n?void 0:n.filter((e=>t!==e))}}});const x="com.mendix.widgets.web.plugin.externalEvents";class A{constructor(){D(this,"channels",void 0),D(this,"id",Math.random().toString().slice(2)),this.channels=new Map}disposeChannel(e){const t=this.channels.get(e);return t&&(t.events={}),this.channels.delete(e)}getChannel(e){let t=this.channels.get(e);return t||(t=T(),this.channels.set(e,t),t)}emit(e,t){for(var n,a=arguments.length,r=new Array(a>2?a-2:0),i=2;i<a;i++)r[i-2]=arguments[i];null===(n=this.channels.get(e))||void 0===n||n.emit(t,...r)}subscribe(e,t,n){return this.getChannel(e).on(t,n),()=>this.unsubscribe(e,t,n)}unsubscribe(e,t,n){const a=this.channels.get(e);if(!a)return;const r=a.events[t];r&&(a.events[t]=r.filter((e=>e!==n)));0===Object.values(a.events).flat().reduce(((e,t)=>t?e+1:e),0)&&this.disposeChannel(e)}}function I(){var e,t;return null!==(t=(e=window)[x])&&void 0!==t?t:e[x]=function(){if(Object.prototype.hasOwnProperty.call(window,x))throw new Error("Widget plugin external events: plugin already initialized!");return new A}()}function q(e,t,a){n((()=>{if(void 0!==e)return I().subscribe(e,t,a)}),[e,t])}class k{constructor(e){var t;D(this,"clearTimers",void 0),D(this,"valueHelper",void 0),D(this,"filterListener",void 0),D(this,"stateListener",void 0),D(this,"_value",void 0),D(this,"_defaultValue",void 0),D(this,"state",void 0),D(this,"dispatchOnMounted",void 0),this._defaultValue=e.defaultValue,this._value=e.defaultValue,this.filterListener=e.onFilterChange,this.dispatchOnMounted=e.dispatchOnMounted,this.valueHelper=e.valueHelper,this.state={inputValue:this.valueHelper.toString(e.defaultValue),filterFn:e.defaultFilter},[this.onInputChange,this.clearTimers]=((e,t)=>{let n=null;const a=()=>{null!==n&&(clearTimeout(n),n=null)};return[function(){for(var r=arguments.length,i=new Array(r),l=0;l<r;l++)i[l]=arguments[l];a(),n=setTimeout((()=>e(...i)),t)},a]})(this.onInputChange.bind(this),null!==(t=e.delay)&&void 0!==t?t:500)}addStateChangeListener(e){this.stateListener=e}dispose(){this.clearTimers(),this.stateListener=void 0,this.filterListener=void 0}set(e,t){return this.state[e]!==t&&(this.state[e]=t,this.dispatchState({...this.state}),!0)}setInputValue(e){this.set("inputValue",e)&&this.onInputChange()}setFilterFn(e){this.set("filterFn",e)&&this.onFilterChange()}dangerous_setValueAndDoNotDispatch(e){return!this.valueHelper.equals(this._value,e)&&(this._value=e,this.set("inputValue",this.valueHelper.toString(e)),!0)}reset(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const[a]=t;this.dangerous_setValueAndDoNotDispatch(a?this._defaultValue:void 0)&&this.dispatchValue()}setupEffect(){return this.dispatchOnMounted&&this.dispatchValue(),()=>this.dispose()}dispatchState(e){var t;null===(t=this.stateListener)||void 0===t||t.call(this,e)}dispatchValue(){var e;null===(e=this.filterListener)||void 0===e||e.call(this,this._value,this.state.filterFn)}onInputChange(){const e=this.valueHelper.fromString(this.state.inputValue);this.valueHelper.equals(this._value,e)||(this._value=e,this.dispatchValue())}onFilterChange(){this.dispatchValue()}}function O(r){const i=function(e){const r=a(e);return n((()=>{r.current=e})),t((function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return r.current&&r.current.apply(void 0,t)}),[])}(r.onFilterChange),s=l((()=>new k({...r,onFilterChange:i})),[]),[u,o]=e((()=>(s.addStateChangeListener((e=>o(e))),s.state))),c=l((()=>({setInputValue:e=>s.setInputValue(e),setFilterFn:e=>{s.setFilterFn(e)},dangerous_setValueAndDoNotDispatch:e=>s.dangerous_setValueAndDoNotDispatch(e),reset:e=>s.reset(e)})),[]);return n((()=>s.setupEffect()),[]),[u,c]}function j(e){var r,i;const l=a(null),s=null!==(r=e.inputDisabled)&&void 0!==r?r:()=>!1,[u,{setFilterFn:o,setInputValue:c,reset:d,dangerous_setValueAndDoNotDispatch:h}]=O({onFilterChange:e.onChange,defaultValue:e.value,defaultFilter:e.defaultFilter,dispatchOnMounted:void 0!==e.value,delay:e.changeDelay,valueHelper:e.valueHelper});return n((()=>{h(e.value)}),[e.value]),function(e){let{widgetName:t,parentChannelName:n,listener:r}=e;const{current:i}=a(r);q(t,V.reset.value,i),q(n,V.reset.value,i)}({widgetName:e.name,parentChannelName:null!==(i=e.parentChannelName)&&void 0!==i?i:void 0,listener:d}),function(e){let{widgetName:t,listener:n}=e;const{current:r}=a(n);q(t,V.set.value,r)}({widgetName:e.name,listener:(t,n)=>{if(t)d([t]);else{const t="number"===e.inputType?n.numberValue.toString():n.stringValue;c(t),o(n.operators)}}}),{defaultFilter:u.filterFn,filters:e.filters,inputType:e.inputType,inputRef:l,inputValue:u.inputValue,inputDisabled:s(u.filterFn),onFilterChange:t(((e,t)=>{var n;(o(e),t)&&(null===(n=l.current)||void 0===n||n.focus())}),[]),onInputChange:t((e=>c(e.target.value)),[])}}const L={fromString:e=>e,toString:e=>null!=e?e:"",equals:(e,t)=>e===t},H=Object.entries({contains:"Contains",startsWith:"Starts with",endsWith:"Ends with",greater:"Greater than",greaterEqual:"Greater than or equal",equal:"Equal",notEqual:"Not equal",smaller:"Smaller than",smallerEqual:"Smaller than or equal",empty:"Empty",notEmpty:"Not empty"}).map((e=>{let[t,n]=e;return{value:t,label:n}}));function _(e){const{defaultFilter:t,value:n,onChange:a,parentChannelName:i,changeDelay:l,...s}=e,u=j({name:s.name,parentChannelName:i,inputType:"text",inputDisabled:e=>"empty"===e||"notEmpty"===e,changeDelay:l,defaultFilter:t,filters:H,value:n,onChange:a,valueHelper:L});return r(E,{...s,...u})}const R=e=>{let{className:t,bootstrapStyle:n,children:a,role:i}=e;return s.count(a)>0?r("div",{className:N("alert alert-".concat(n),t),role:i},a):null};var M;R.displayName="Alert",function(e){e.STRING="string",e.NUMBER="number",e.ENUMERATION="enum",e.DATE="date",e.ASSOCIATION="association"}(M||(M={}));const P="com.mendix.widgets.web.filterable.filterContext";function W(e){if(e&&1===e.length){const[t]=e;let n="equal";switch(t.type){case"contains":n="contains";break;case"starts-with":n="startsWith";break;case"ends-with":n="endsWith";break;case">":n="greater";break;case">=":n="greaterEqual";break;case"=":n="equal";break;case"!=":n="notEqual";break;case"<":n="smaller";break;case"<=":n="smallerEqual"}return{type:n,value:String(t.value)}}}function B(e){const t=a("TextFilter".concat(function(){const e="com.mendix.widgets.web.UUID";return window[e]||(window[e]=1),window[e]++}())),n=function(e){const t=a(null);return"loading"!==(null==e?void 0:e.status)&&null===t.current&&(t.current=null==e?void 0:e.value),t.current}(e.defaultValue),i=window[P],l=r(R,{bootstrapStyle:"danger"},"The Text filter widget must be placed inside the header of the Data grid 2.0 or Gallery widget."),s=r(R,{bootstrapStyle:"danger"},'The Text filter widget can\'t be used with the filters options you have selected. It requires a "Hashed string or String" attribute to be selected.');return(null==i?void 0:i.Consumer)?r(i.Consumer,null,(a=>{var i,o,c,d,h,p,v;if(!a||!a.filterDispatcher||!a.singleAttribute&&!a.multipleAttributes)return l;const{filterDispatcher:f,singleAttribute:g,multipleAttributes:m,singleInitialFilter:b,multipleInitialFilters:y}=a,w=[...g?[g]:[],...m&&null!==(i=G(m))&&void 0!==i?i:[]];if(0===w.length)return m?s:l;const C=W(b||(null==y?void 0:y[w[0].id])),N=(S=w[0].type)&&!S.match(/HashString|String/)?"The attribute type being used for Text filter is not 'Hashed string or String'":null;var S;return N?r(R,{bootstrapStyle:"danger"},N):null===n?null:r(_,{adjustable:e.adjustable,className:e.class,defaultFilter:null!==(o=null==C?void 0:C.type)&&void 0!==o?o:e.defaultFilter,value:null!==(c=null==C?void 0:C.value)&&void 0!==c?c:n,changeDelay:e.delay,id:t.current,placeholder:null===(d=e.placeholder)||void 0===d?void 0:d.value,screenReaderButtonCaption:null===(h=e.screenReaderButtonCaption)||void 0===h?void 0:h.value,screenReaderInputCaption:null===(p=e.screenReaderInputCaption)||void 0===p?void 0:p.value,styles:e.style,tabIndex:e.tabIndex,parentChannelName:null!==(v=a.eventsChannelName)&&void 0!==v?v:null,name:e.name,onChange:(t,n)=>{var a,r;null===(a=e.valueAttribute)||void 0===a||a.setValue(t),null===(r=e.onChange)||void 0===r||r.execute();const i=null==w?void 0:w.map((e=>U(e,t,n))).filter((e=>void 0!==e));f({getFilterCondition:()=>i&&i.length>1?u(...i):null==i?void 0:i[0],filterType:M.STRING})}})})):l}function G(e){if(e)return Object.keys(e).map((t=>e[t])).filter((e=>e.type.match(/HashString|String/)))}function U(e,t,n){if(!e||!e.filterable||"empty"!==n&&"notEmpty"!==n&&!t)return;return{contains:d,startsWith:h,endsWith:p,greater:v,greaterEqual:f,equal:g,notEqual:m,smaller:b,smallerEqual:y,empty:g,notEmpty:m}[n](o(e.id),c("empty"===n||"notEmpty"===n?void 0:t))}export{B as default};
